<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Todo</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const API_BASE = 'http://127.0.0.1:8000';

      async function apiFetch(path, options = {}) {
        const res = await fetch(`${API_BASE}${path}`, {
          headers: { 'Content-Type': 'application/json' },
          ...options,
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg =
            data && (data.detail || data.error)
              ? data.detail || data.error
              : `HTTP ${res.status}`;
          throw new Error(msg);
        }

        return data;
      }

      // 여기에 React 코드 작성
      // 리액트가 처음으로 실행되는 부분
      function App() {
        const [todos, setTodos] = React.useState([]);
        const [title, setTitle] = React.useState('');
        const [loading, setLoading] = React.useState(false);

        async function loadTodos() {
          const data = await apiFetch('/todos');
          setTodos(data);
        }

        React.useEffect(() => {
          loadTodos();
        }, []);

        async function addTodo() {
          const t = title.trim();
          if (!t) return;

          setLoading(true);
          try {
            const data = await apiFetch(
              `/todos?title=${encodeURIComponent(t)}`,
              {
                method: 'POST',
              }
            );
            await loadTodos();
          } catch (err) {
            console.error(err);
          } finally {
            setLoading(false);
          }
        }

        return (
          <div>
            <ul>
              {todos.map((todo) => (
                <li key={todo.id}>
                  {todo.title} {todo.completed ? '(완료)' : ''}{' '}
                  <button>완료</button> <button>삭제</button>
                </li>
              ))}
            </ul>

            <div>
              <input
                type="text"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
              />
              <button onClick={addTodo} disabled={loading}>
                추가
              </button>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </head>
  <body>
    <h1>Todo</h1>
    <div id="root"></div>
  </body>
</html>
